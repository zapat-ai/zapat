{{TASK_ASSESSMENT}}

## PR Details
- **Repository**: {{REPO}}
- **PR #{{PR_NUMBER}}**: {{PR_TITLE}}
- **Branch**: {{PR_BRANCH}}
- **Complexity**: {{COMPLEXITY}}

## Original PR Description
{{PR_BODY}}

## Review Feedback
{{REVIEW_COMMENTS}}

## Change Requests
{{PR_REVIEWS}}

## Project Context
{{PROJECT_CONTEXT}}

## Workflow

{{#IF_CLAUDE}}
If you are spawning a team, your **FIRST action** must be to call the `TeamCreate` tool, then use the `Task` tool to spawn each teammate. Only skip team creation if the feedback is confirmed style-nits-only with no blocking issues.

1. **Analyze Feedback**:
   Read all review feedback carefully. Classify each piece using the Feedback Triage Guide below. Announce your classification and team decision before proceeding.

2. **Phase 1 — Blocking Issues (must fix):**
   - Address ALL blocking issues first — things marked as "blocking", "must fix", "required", or that point out bugs, security issues, or correctness problems.
   - Commit with message: `fix: address blocking review feedback on PR #{{PR_NUMBER}}`
   - Push to the existing branch. Do NOT force-push or rebase — add commits on top.

3. **Phase 2 — Suggestions & Improvements (should fix):**
   - Address ALL remaining feedback — suggestions, improvements, refactoring ideas, naming changes, documentation additions, test suggestions, and "nice to have" items.
   - Treat suggestions as actionable work, not optional. If a reviewer suggested it, implement it unless it contradicts another reviewer's feedback or violates safety rules.
   - Commit SEPARATELY from blocking fixes with message: `refactor: implement review suggestions on PR #{{PR_NUMBER}}`
   - This separate commit allows reverting suggestions independently if needed.

4. **Phase 3 — Review** (skip if working solo):
   - If you spawned a security reviewer: After builder pushes both commits, verify all security-related feedback was correctly addressed. Check that new commits didn't introduce new issues.
   - If you spawned a product manager: After builder pushes, verify the original acceptance criteria are still met and no regressions were introduced. Confirm both blocking issues AND suggestions were addressed.
   - All send their assessment to you (the lead).

5. **Shut down the team** when done (skip if working solo).
{{/IF_CLAUDE}}
{{#IF_CODEX}}
You are working solo. Address all review feedback sequentially.

1. **Analyze Feedback**:
   Read all review feedback carefully. Classify each piece using the Feedback Triage Guide below.

2. **Phase 1 — Blocking Issues (must fix):**
   - Address ALL blocking issues first — things marked as "blocking", "must fix", "required", or that point out bugs, security issues, or correctness problems.
   - Commit with message: `fix: address blocking review feedback on PR #{{PR_NUMBER}}`
   - Push to the existing branch. Do NOT force-push or rebase — add commits on top.

3. **Phase 2 — Suggestions & Improvements (should fix):**
   - Address ALL remaining feedback — suggestions, improvements, refactoring ideas, naming changes, documentation additions, test suggestions, and "nice to have" items.
   - Treat suggestions as actionable work, not optional. If a reviewer suggested it, implement it unless it contradicts another reviewer's feedback or violates safety rules.
   - Commit SEPARATELY from blocking fixes with message: `refactor: implement review suggestions on PR #{{PR_NUMBER}}`

4. **Phase 3 — Self-Review:**
   - Verify all security-related feedback was correctly addressed and no new issues were introduced.
   - Verify the original acceptance criteria are still met and no regressions were introduced.
{{/IF_CODEX}}

## Feedback Triage Guide

The builder should classify each piece of feedback:

| Category | Examples | Action |
|----------|----------|--------|
| **Blocking** | "This will crash if...", "Security issue:", "Bug:", "Missing null check", "This breaks..." | Fix in Phase 1 commit |
| **Missing tests** | "Tests are missing for...", "[BLOCKING] No unit tests", "Test coverage" | Write tests in Phase 1 commit (blocking) |
| **Suggestion** | "Consider using...", "It would be better to...", "You could simplify...", "Nit:", "Minor:", "Optional:" | Implement in Phase 2 commit |
| **Question** | "Why did you...?", "Is this intentional?" | Answer in PR comment, fix if it reveals an issue |

When in doubt, implement it. It's better to over-address feedback than to leave suggestions unimplemented.

**If the review flags missing tests as blocking**: Write the required unit/integration tests. Set up test infrastructure if needed — detect the stack (package.json → Jest/Vitest, .xcodeproj → XCTest), install devDependencies, create config files, and for .mjs files configure Jest ESM with `NODE_OPTIONS=--experimental-vm-modules`. Mock external dependencies, never make real API calls, and use fictional test data.

### Safety Notes
- NEVER force-push or rebase the branch
- Keep changes focused on the review feedback — no unrelated changes
